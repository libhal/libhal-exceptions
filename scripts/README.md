# Scripts

The scripts for testing and playing around with libhal exceptions.

## `nearpoint.py`

```plaintext
usage: nearpoint.py [-h] [-b BLOCK_POWER] [-s SMALL_BLOCK_POWER] [-e ERROR_THRESHOLD] [--auto-optimize] [--tool-prefix TOOL_PREFIX] -m MAP
                    [-o ORDER_FILE] [-n NEARPOINT_FILE] [-v]
                    elf_file

Generate nearpoint exception tables and linker script from a .map and .elf file

positional arguments:
  elf_file              Path to the ELF binary

options:
  -h, --help            show this help message and exit
  -b BLOCK_POWER, --block-power BLOCK_POWER
                        Normal block size power of 2 (0 = auto-optimize)
  -s SMALL_BLOCK_POWER, --small-block-power SMALL_BLOCK_POWER
                        Small block size power of 2 (0 = auto-optimize) (NOT CURRENTLY SUPPORTED!)
  -e ERROR_THRESHOLD, --error-threshold ERROR_THRESHOLD
                        Error threshold for small table generation (default: 8, min: 4) (NOT CURRENTLY SUPPORTED!)
  --auto-optimize       Automatically find optimal block sizes (NOT CURRENTLY SUPPORTED!)
  --tool-prefix TOOL_PREFIX
                        Toolchain prefix for objdump/nm (e.g., "arm-none-eabi-" or full path)
  -m MAP, --map MAP     Path to map file for executable
  -o ORDER_FILE, --order_file ORDER_FILE
                        Path to where to store the ordering file.
  -n NEARPOINT_FILE, --nearpoint_file NEARPOINT_FILE
                        Path to where to store the nearpoint table.
  -v, --verbose         Enable verbose logging
```

You will need to pass in the map file generated by your linker as well as the
final elf file.

```bash
python3 nearpoint.py --tool-prefix="/path/to/arm-none-eabi/bin/" --map="app.elf.map" app.elf
```

This will generate a `order.ld` file which you can add as an additonal linker
script with `-Torder.ld`. The `order.ld` file uses the `INSERT BEFORE .text`
directive which allows it to be added to the set of linkers and does not
overtake your linker script.

This command will also generate a `nearpoint.cpp` which contains the nearpoint
descriptor and the nearpoint table.

## `prel31.py`

Converts a positive relative 31-bit (or `prel31`) number and the location of the number to the absolute address of where the object points to.

```plaintext
usage: prel31.py [-h] [-a ADDRESS] [-e {big,little}] prel31_offset

Converts a positive relative 31-bit (or `prel31`) number and the location of the number to the absolute address of where the object points to.

positional arguments:
  prel31_offset         value to convert

options:
  -h, --help            show this help message and exit
  -a ADDRESS, --address ADDRESS
                        Address of the prel31 offset value which is needed to get an absolute value. The default of 0 returns the relative offset
                        from the value
  -e {big,little}, --endian {big,little}
                        Set the endianess of the prel31_offset. The address must be big endian (or the way its spelled)
```
